---
title: "00_fluo_test"
output:
  html_document:
    df_print: paged
date: "2025-04-10"
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Packages
```{r packages}
library(ncdf4) 
library(raster) 
library(ggplot2)
library(dplyr)
library(lubridate)
library(data.table)
library(oce)
library(terra)
library(tidyterra)
library(cmocean)

```

## Variables
```{r variables}
MAX_CHLA_DEPTH <- 200       # define depth at which to consider dark signal (CHLA "absolute zero")
SURFACE_NOT_NAN <- 4:10

DDU_loc=NULL
DDU_loc$lat = -66.663253
DDU_loc$lon = 140.002335
DDU_loc=as.data.frame(DDU_loc)

# DDU_LAT_LIM = c(-70, -65)
# DDU_LON_LIM = c(135, 150)
```

## Paths
```{r paths}
ROOT_PROJ <- "/home/cactus/Documents/Oceano/M2/LOCEAN/Weddell_seal_fluo"

DATA_FOLDER <- "oceanographic_data"
DEPLOY_FOLDER <- "wd11"
SEAL_NAME <- "wd11-687-18"
SEAL_FILE <- paste0(SEAL_NAME, "_hr2_prof.nc")
NC_PATH <- file.path(ROOT_PROJ, DATA_FOLDER, DEPLOY_FOLDER, SEAL_FILE)

BATHY_FOLDER <- "bathy"
FINE_TOPO_FILE <- "gvdem100v3/w001001.adf"
LARGE_TOPO_FILE <- "gebco_2023_n-50.0_s-79.0_w90.0_e180.0.tif"
BATHY_PATH_FINE <- file.path(ROOT_PROJ, BATHY_FOLDER, FINE_TOPO_FILE)
BATHY_PATH_LARGE <- file.path(ROOT_PROJ, BATHY_FOLDER, LARGE_TOPO_FILE)

FAST_ICE_FOLDER <- "fast_ice"
FAST_ICE_FILE <- "mertz_sara_akiko_19.nc"
FAST_ICE_PATH <- file.path(ROOT_PROJ, FAST_ICE_FOLDER, FAST_ICE_FILE)
```

## NetCfd code
```{r nc-code}
nc_data <- nc_open(NC_PATH)
# print(nc_data)
lon <- ncvar_get(nc_data, "LONGITUDE")
lat <- ncvar_get(nc_data, "LATITUDE")
chla <- ncvar_get(nc_data, "CHLA")
light <- ncvar_get(nc_data, "LIGHT")
temp <- ncvar_get(nc_data, "TEMP_ADJUSTED")
psal <- ncvar_get(nc_data,"PSAL_ADJUSTED")
pres <- ncvar_get(nc_data, "PRES")
juld <- ncvar_get(nc_data, "JULD")
```

## Long Lat Light
```{r dataframe}
max_depth_dataset <- 150
m = 1:max_depth_dataset
n = 5

origin_date <- as.Date("1950-01-01 00:00:00")
dateTime <- origin_date + juld
```

```{r corrected lon lat}
diag <- read.csv("diag_2017-2024_forclaude_07apr24.csv", stringsAsFactors = FALSE)
diag$date <- as.POSIXct(diag$date, format="%Y-%m-%d %H:%M")

# extraire l'individu qui nous intéresse et trier par date
df_wd11 <- diag %>% filter(id == SEAL_NAME)
df_wd11 <- df_wd11 %>% arrange(date)

t1 <- as.numeric(df_wd11$date )
t2 <- as.numeric(as.POSIXct(dateTime))

cols <- c("lat", "lon")
interp_results <- lapply(cols, function(col) {
  approx(x = t1, y = df_wd11[[col]], xout = t2, rule = 2)$y
})

names(interp_results) <- paste0(cols, "_corr")
df_interp <- as.data.frame(interp_results)

df_original <- data.frame(lon = lon, lat = lat)

ggplot() +
  geom_point(data = df_original, 
             aes(x = lon, y = lat, color = "Original"), 
             alpha = 0.4, size = 2) +
  geom_point(data = df_interp, 
             aes(x = lon_corr, y = lat_corr, color = "Interpolated"), 
             alpha = 0.4, size = 2) +
  scale_color_manual(
    name = "Type de données",
    values = c("Original" = "blue", "Interpolated" = "red")
  ) +
  labs(
    title = paste0(SURFACE_NOT_NAN[1], " to ", SURFACE_NOT_NAN[length(SURFACE_NOT_NAN)], 
      " m deep"
    ),
    x = "Longitude",
    y = "Latitude"
  ) +
  theme_minimal()
```

```{r}
lon <- df_interp$lon_corr
lat <- df_interp$lat_corr
```

```{r NaColumns}
col_na_only <- apply(light, 2, function(col) all(is.na(col)))
which(col_na_only)

cat("Number of only N/A columns :", sum(col_na_only), "\n\n")
```

```{r NaColumns}
light_subset <- light[1:MAX_CHLA_DEPTH, !col_na_only] # sesf031_light_data_preprocess1_nonNan2 : erasing NaN profiles
lat_subset <- lat[!col_na_only]
lon_subset <- lon[!col_na_only]
date_subset <- dateTime[!col_na_only]

chla_subset <- chla [1:MAX_CHLA_DEPTH, !col_na_only]
temp_subset <- temp [1:MAX_CHLA_DEPTH, !col_na_only]
psal_subset <- psal [1:MAX_CHLA_DEPTH, !col_na_only]
pres_subset <- pres [1:MAX_CHLA_DEPTH, !col_na_only]

total_light <- colSums(light_subset, na.rm = TRUE)
profil_names <- as.character(seq_along(total_light))

plot(
  total_light,
  type = "b",                     
  pch = 18,                        
  col = "blue",
  xlab = "Profil n°",
  ylab = "Total lumière (µmol/m²/s)",
  main = paste0("Lumière totale par profile : ", SEAL_NAME, " (en rouge les colonnes N/A)"),
  xaxt = "n"                       
)

axis(1, at = seq(1, length(profil_names), by = 20), labels = profil_names[seq(1, length(profil_names), by = 20)])
```

```{r DarkValue}

last_nonzero_vals <- sapply(1:ncol(light_subset), function(n) {
  idx <- which(!is.na(light_subset[, n]) & light_subset[, n] != 0)
  if (length(idx) > 0) {
    light_subset[max(idx), n]
  }
})

light_corrected <- sweep(light_subset, 2, last_nonzero_vals, FUN = "-") # dark-value ? Not sure mhmhmhm

# Plot only one of the 150
plot(light_subset[1:MAX_CHLA_DEPTH, n], pres[1:MAX_CHLA_DEPTH, n], type = "l", col = "blue",
     ylim = rev(range(pres[1:200, n], na.rm = TRUE)),
     xlim = c(-10,15),
     xlab = "Light", ylab = "Depth", main = paste("Profil", n, "- Dark value: ", last_nonzero_vals[n]))

lines(light_corrected[1:MAX_CHLA_DEPTH, n], pres[1:MAX_CHLA_DEPTH, n], col = "red")

legend("bottomright", legend = c("Original", "Corrected"),
       col = c("blue", "red"), lty = 1, bty = "n")
```
```{r}
## CODE MATLAB

# # Copier les données d'origine
# L_adNonLogRegDkSa <- L_adNonLogRegDk
# np_tot <- ncol(L_adNonLogRegDk)
# satDepth_temp <- rep(1, np_tot)  # profondeur valide par défaut : surface
# 
# # Boucle sur les profils valides
# for (ii_temp in which(idx031_lightNonNan)) {
#   diffL_temp <- diff(L_adNonLogRegDk[, ii_temp])
#   first_valid <- lightData$firstNonNan[ii_temp]
#   
#   if (diffL_temp[first_valid] < 0) {
#     # pas de saturation détectée
#     next
#   } else {
#     # chercher la profondeur où ça recommence à décroître
#     satTestDepth_temp <- first_valid + 1
#     while (satTestDepth_temp <= length(diffL_temp) && diffL_temp[satTestDepth_temp] >= 0) {
#       satTestDepth_temp <- satTestDepth_temp + 1
#     }
#     satDepth_temp[ii_temp] <- satTestDepth_temp
#     # remplacer les données saturées par NA
#     L_adNonLogRegDkSa[1:(satTestDepth_temp - 1), ii_temp] <- NA
#   }
# }
# 
# # Mise à jour de lightData
# lightData$saturationDepth <- satDepth_temp
# 
# # Log naturel des données corrigées
# L_adLogRegDkSa <- log(L_adNonLogRegDkSa)

```

```{r}
matplot(light[1:MAX_CHLA_DEPTH,], pres[1:MAX_CHLA_DEPTH,],
        type = "l",
        ylim = rev(c(0, MAX_CHLA_DEPTH)),
        lty = 1,
        xlab = "Light (µmol/m²/s)",
        ylab = "Depth (m)",
        main = paste0("Light profiles : ", SEAL_NAME))
grid()

matplot(light_corrected, pres[1:MAX_CHLA_DEPTH,],
        type = "l",
        ylim = rev(c(0, MAX_CHLA_DEPTH)),
        lty = 1,
        xlab = "Light (µmol/m²/s)",
        ylab = "Depth (m)",
        main = paste0("Light profiles corrected : ", SEAL_NAME))
grid()

light <- light_corrected
```
```{r SaveAndClassifyLightProfiles, echo=FALSE}

dir_standard = "profils_light_standard"
dir_atypique = "profils_light_atypique"
dir.create(dir_standard, showWarnings = FALSE)
dir.create(dir_atypique, showWarnings = FALSE)

nlight = ncol(light)

for (i in 1:nlight) {
  profil_light <- light[, i]
  profil_pres <- pres_subset[, i]
  
  delta_light <- profil_light - profil_light[1]

  if (any(delta_light > 0, na.rm = TRUE)) {
    class_dir <- dir_atypique
  } else {
    class_dir <- dir_standard
  }
  
  filename <- paste0(class_dir, "/profil_light", i, ".png")
  
  png(filename, width = 800, height = 600)
  
  plot(profil_light, profil_pres,
       type = "l",
       xlim = c(-10,10),
       ylim = rev(c(0, MAX_CHLA_DEPTH)),
       xlab = "Light (µmol/m²/s)",
       ylab = "Press",
       main = paste("Profil light - Col", i))
  grid()
  
  dev.off()
}

cat("Classification terminée :\n")
cat(nlight, "profils analysés\n")
cat("->", length(list.files(dir_standard)), "profils standards dans", dir_standard, "\n")
cat("->", length(list.files(dir_atypique)), "profils atypiques dans", dir_atypique, "\n\n")

```

```{r PlotOneProfile}
# Layout pour 3 graphiques côte à côte
par(mfrow = c(1, 4))

n = 114

# Plot 1: Lumière
plot(light[m,n], pres[m,n],
     type = "l",
     xlim = range(light[,n], na.rm = TRUE),
     ylim = rev(c(0, max_depth_dataset)),
     xlab = "Light (µmol/m²/s)",
     ylab = "Depth (m)")
grid()

# Plot 2: Température
plot(temp[m,n], pres[m,n],
     type = "l",
     xlab = "Temperature (°C)",
     xlim = range(temp[,n], na.rm = TRUE),
     ylim = rev(c(0, max_depth_dataset)),
     ylab = "")
grid()

# Plot 3: Salinité
plot(psal[m,n], pres[m,n],
     type = "l",
     xlab = "Salinity",
     xlim = range(psal[,n], na.rm = TRUE),
     ylim = rev(c(0, max_depth_dataset)),
     ylab = "")
grid()

# Plot 4: Chla
plot(chla[m,n], pres[m,n],
     type = "l",
     xlab = "CHLA (fluo)",
     xlim = c(-10, 10),
     ylim = rev(c(0, max_depth_dataset)),
     ylab = "")
grid()

mtext(paste0(SEAL_NAME, " : ", n, "/", ncol(light)), side = 3, line = -2, outer = TRUE)

```

```{r dataframe}

light_surface_interval <- light[SURFACE_NOT_NAN, , drop = FALSE]
light_surf_avg <- apply(light_surface_interval, 2, function(x) mean(x, na.rm = TRUE))

light_20m <- light[20, ]
light_40m <- light[40, ]

df_light_surface <- data.frame(
  lon = lon_subset,
  lat = lat_subset,
  light_surf = light_surf_avg,
  light_20 = light_20m,
  light_40 = light_40m
)

df_surface_clean <- df_light_surface %>% filter(!is.na(light_surf))
df_20m_clean <- df_light_surface %>% filter(!is.na(light_20))
df_40m_clean <- df_light_surface %>% filter(!is.na(light_40))

n_profiles_surf <- length(df_surface_clean$light_surf)
n_profiles_20 <- length(df_20m_clean$light_20)
n_profiles_40 <- length(df_40m_clean$light_40)

ggplot(df_surface_clean, aes(x = lon, y = lat, color = light_surf)) +
  geom_point(size = 2) +
  scale_color_viridis_c() +
  labs(
    title = paste0(n_profiles_surf," light profiles (", SURFACE_NOT_NAN[1], " to ",SURFACE_NOT_NAN[7],"m deep)"),
    x = "Longitude",
    y = "Latitude",
    color = "Light\nln(µmol/m²/s)"
  ) +
  theme_minimal()

ggplot(df_20m_clean, aes(x = lon, y = lat, color = light_20)) +
  geom_point(size = 2) +
  scale_color_viridis_c() +
  labs(
    title = paste0(n_profiles_20," light profiles (", 20,"m deep)"),
    x = "Longitude",
    y = "Latitude",
    color = "Light\nln(µmol/m²/s)"
  ) +
  theme_minimal()

ggplot(df_40m_clean, aes(x = lon, y = lat, color = light_40)) +
  geom_point(size = 2) +
  scale_color_viridis_c() +
  labs(
    title = paste0(n_profiles_40, " light profiles (", 40,"m deep)"),
    x = "Longitude",
    y = "Latitude",
    color = "Light\nln(µmol/m²/s)"
  ) +
  theme_minimal()
```

```{r LightThroughTime}
solar_angle = sunAngle(date_subset, lon_subset, lat_subset)$altitude
solar_threshold <- -12

df_solar <- data.frame(
  solar_angle,
  l = light_surf_avg
)

df_solar <- df_solar %>%
  mutate(period = case_when(
    solar_angle > 0 ~ "Day",
    solar_angle <= 0 & solar_angle > solar_threshold ~ "Twilight",
    solar_angle <= solar_threshold ~ "Night"
  ))

nPeriod = df_solar %>%  count(period)

ggplot(df_solar, aes(x = date_subset, y = solar_angle, color = period)) +
  geom_point() +
  labs(title = "Solar Angle",
       x = "Date", y = "Solar Angle (°)") +
  scale_color_manual(values = c("Day" = "red", "Twilight" = "green", "Night" = "navy")) +
  theme_minimal()

ggplot(df_solar, aes(x = date_subset, y = l, color = period)) +
  geom_point() +
  labs(title = paste0("Light (", SURFACE_NOT_NAN[1], " to ",SURFACE_NOT_NAN[7], "m deep)"),
       x = "Date", y = "ln(µmol/m²/sec)") +
  scale_color_manual(values = c("Day" = "red", "Twilight" = "green", "Night" = "navy")) +
  theme_minimal()

cat("Number of Day values :", nPeriod$n[1], "\n")
cat("Number of Night values :", nPeriod$n[2], "\n")
cat("Number of Twilight values :", nPeriod$n[3], "\n")
```
```{r}
df_solar$lon <- lon_subset
df_solar$lat <- lat_subset

lon_median <-  mean(lon_subset, na.rm = TRUE) # 139.9
lat_median <-  mean(lat_subset, na.rm = TRUE) # -66.625

df_solar <- df_solar %>%
  mutate(zone = case_when(
    lon <= lon_median & lat >= lat_median ~ "Nord-Ouest",
    lon > lon_median & lat >= lat_median ~ "Nord-Est",
    lon <= lon_median & lat < lat_median ~ "Sud-Ouest",
    lon > lon_median & lat < lat_median ~ "Sud-Est"
  ))

ggplot(df_solar, aes(x = date_subset, y = l, color = period, shape = zone)) +
  geom_point() +
  labs(title = "Lumière en fonction de la période et de la zone",
       x = "Date", y = "ln(µmol/m²/sec)") +
  scale_color_manual(values = c("Day" = "red", "Twilight" = "green", "Night" = "navy")) +
  theme_minimal()

ggplot(df_solar, aes(x = lon, y = lat, color = zone, shape = period)) +
  geom_point(size = 3, alpha = 0.8) +
  labs(title = "Zones (couleur) et période jour/nuit/crépuscule (forme)",
       x = "Longitude", y = "Latitude") +
  scale_color_manual(values = c("Nord-Ouest" = "darkorange",
                                "Nord-Est" = "purple",
                                "Sud-Ouest" = "blue",
                                "Sud-Est" = "darkgreen")) +
  scale_shape_manual(values = c("Day" = 16, "Twilight" = 17, "Night" = 15)) +
  theme_minimal()

```
```{r}
df_solar <- df_solar %>%
  mutate(distance_to_center = sqrt((lon - lon_median)^2 + (lat - lat_median)^2))

df_solar <- df_solar %>%
  mutate(distance_group = case_when(
    distance_to_center < 0.05 ~ "Centre",
    distance_to_center < 0.15 ~ "Périphérie proche",
    TRUE ~ "Périphérie lointaine"
  ))

ggplot(df_solar, aes(x = lon, y = lat, color = distance_group, shape = period)) +
  geom_point(size = 2, alpha = 0.8) +
  labs(title = "",
       x = "Longitude", y = "Latitude") +
  scale_color_manual(values = c("Centre" = "firebrick",
                                "Périphérie proche" = "goldenrod",
                                "Périphérie lointaine" = "steelblue")) +
  scale_shape_manual(values = c("Day" = 16, "Twilight" = 17, "Night" = 15)) +
  theme_minimal()

```

```{r extract Suspicious solar profiles}
max_night_light <- df_solar %>%
  filter(period == "Night") %>%
  summarise(max_light = max(l, na.rm = TRUE)) %>%
  pull(max_light)

night_rows <- which(df_solar$period == "Night")
local_max_index <- which.max(df_solar$l[night_rows])
global_max_index <- night_rows[local_max_index]

cat("profil index: ", global_max_index, " - Value: ", max_night_light,"\n")

plot(light[m,global_max_index], pres[m,global_max_index],
     type = "l",
     xlim = range(light[,global_max_index], na.rm = TRUE),
     ylim = rev(c(0, max_depth_dataset)),
     xlab = "Light ln(µmol/m²/s)",
     ylab = "Depth (m)")
grid()

```

## Light and ice
```{r}
prj <- "+proj=stere +lat_0=-90 +lat_ts=-70 +datum=WGS84"
ex <- c(-2691055, 2933945, -2390156, 2309844)

fast_ice_raster <- rast(FAST_ICE_PATH, "Fast_Ice_Time_Series")
set.ext(fast_ice_raster, ext(ex))
set.crs(fast_ice_raster, crs(prj))
#plot(fast_ice_raster[[1]], legend = FALSE) # le continent

lon_min <- 130
lon_max <- 160
lat_min <- -66.5
lat_max <- -63

points <- cbind(
  lon = c(lon_min, lon_max),  
  lat = c(lat_min,lat_max)
)

prjpoints <- project(points, to = prj, from = "EPSG:4326")
new_ex<-extent(prjpoints[2,1],prjpoints[1,1],prjpoints[2,2],prjpoints[1,2])
new_r=crop(fast_ice_raster,new_ex)
# From feb to may
time_index <- seq(1,4, by = 1) 
x_sub <- subset(new_r, time_index)
plot(x_sub, legend = FALSE)
```

```{r}
fine_topo <- raster(BATHY_PATH_FINE)
fine_topo[fine_topo >=0] <-NA
fine_topo_spat <- terra::rast(fine_topo)

large_topo <- raster(BATHY_PATH_LARGE)
large_topo[large_topo >=0] <-NA
large_topo_spat <- terra::rast(large_topo)
```

```{r}
fine_topo_spat <- crop(fine_topo_spat, extent(139.5, 141.5, -67, -66.4))
large_topo_spat <- crop(large_topo_spat, extent(139.5, 141.5, -67, -66.4))

x_sub2= project(x_sub, crs(large_topo_spat), 
                res = res(large_topo_spat)) 

# Create a sequence of months between the first and last month
start <- format(as.Date("2019-02-05"), "%m")
end <- format(as.Date("2019-05-06"), "%m")

months_seq <- seq(from = start, to = end)

# Extract the month names from the sequence
month_names <- paste0("2019 - ", month.name[months_seq])

names(x_sub2) <- month_names
plot(x_sub2, legend = FALSE)
x_sub2 <- crop(x_sub2, extent(139.5, 141.5, -67, -66.4))
plot(x_sub2, legend = FALSE)
```

```{r}
#description: Classified surface type: 0 = pack ice or ocean; 1 = continent; 2 = islands; 3 = ice shelf; 4 = fast ice; 5 = manual fast ice edge; 6 = auto fast ice edge.
# x_sub2[x_sub2 == 0 | x_sub2 == 3 | x_sub2 == 5| x_sub2 == 6] <- NA

glacier=x_sub2[[1]]
# glacier=round(glacier)

ggplot() +
  geom_spatraster_contour(data = fine_topo_spat, alpha = 0.6)+ #bathy
  geom_spatraster_contour_text(data = fine_topo_spat, binwidth=300)+
  geom_spatraster(data = glacier, alpha = 0.6) + #glace
  geom_spatraster_contour_text(data = fine_topo_spat, alpha = 0.6)+
  scale_fill_cmocean(name = "deep", direction = -1, alpha = 0.5, guide = guide_legend(title = "Type"))+
  geom_point(data = df_surface_clean, aes(x = lon, y = lat), shape = 21, color = "black", fill = "yellow", size = 1) + 
  scale_x_continuous(breaks = c(140, 141)) +
  scale_y_continuous(breaks = c(-66.4, -66.8))+
  xlab("Longitude") + ylab("Latitude")+
  theme_minimal()

```

```{r}

# latlon_box <- extent(c(lon_min, lon_max, lat_min, lat_max))
# latlon_raster <- raster(latlon_box, crs = CRS("+proj=longlat +datum=WGS84"))
# 
# projected_extent <- extent(projectExtent(latlon_raster, projection(amsr2))) #crs(amsr2)
# 
# cropped_raster <- crop(amsr2, projected_extent)
# projected_raster <- projectRaster(cropped_raster, crs = CRS("+init=epsg:4326"))
# plot(projected_raster)
# points(df$lon, df$lat, pch = 4, col = "black", cex = 1)

```

